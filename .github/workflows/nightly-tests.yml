name: ðŸŒ™ Nightly Tests

on:
  schedule:
    # Run every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  NODE_VERSION: '18'

jobs:
  # ==================== COMPREHENSIVE TESTING ====================
  
  full-test-suite:
    name: ðŸ§ª Full Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['16', '18', '20']
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: ðŸ§ª Frontend tests
        working-directory: ./frontend
        run: |
          npm ci
          npm run lint
          npm run build

      - name: ðŸ§ª Backend tests
        working-directory: ./backend
        run: |
          npm ci
          npm test
        env:
          DB_HOST: localhost
          DB_PORT: 3306
          DB_NAME: test_db
          DB_USERNAME: root
          DB_PASSWORD: root

  # ==================== PERFORMANCE TESTING ====================
  
  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ—ï¸ Build frontend
        working-directory: ./frontend
        run: |
          npm ci
          npm run build

      - name: âš¡ Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './.lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ==================== SECURITY AUDIT ====================
  
  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Run comprehensive security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'trivy-results.json'

      - name: ðŸ“Š Process security results
        run: |
          if [ -f trivy-results.json ]; then
            echo "ðŸ“Š Security scan results:"
            cat trivy-results.json | jq '.Results[] | select(.Vulnerabilities) | .Vulnerabilities | length' | awk '{sum+=$1} END {print "Total vulnerabilities found: " sum}'
          fi

      - name: ðŸ” Check for secrets
        run: |
          echo "ðŸ” Scanning for secrets in codebase..."
          # Install truffleHog or similar tool
          docker run --rm -v "$PWD:/pwd" trufflesecurity/trufflehog:latest filesystem /pwd --json > secrets-scan.json
          
          if [ -s secrets-scan.json ]; then
            echo "âš ï¸ Potential secrets found!"
            cat secrets-scan.json
          else
            echo "âœ… No secrets detected"
          fi

  # ==================== DEPENDENCY ANALYSIS ====================
  
  dependency-analysis:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ” Analyze frontend dependencies
        working-directory: ./frontend
        run: |
          npm ci
          echo "ðŸ“Š Frontend dependency analysis:"
          npm ls --depth=0
          npm audit --json > frontend-audit.json
          
          echo "ðŸ” Checking for outdated packages:"
          npm outdated --json > frontend-outdated.json || true

      - name: ðŸ” Analyze backend dependencies
        working-directory: ./backend
        run: |
          npm ci
          echo "ðŸ“Š Backend dependency analysis:"
          npm ls --depth=0
          npm audit --json > backend-audit.json
          
          echo "ðŸ” Checking for outdated packages:"
          npm outdated --json > backend-outdated.json || true

      - name: ðŸ“Š Generate dependency report
        run: |
          echo "# ðŸ“¦ Dependency Report" > dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md
          
          echo "## Frontend Dependencies" >> dependency-report.md
          if [ -f frontend/frontend-audit.json ]; then
            echo "### Security Audit" >> dependency-report.md
            cat frontend/frontend-audit.json | jq -r '.metadata | "- Total dependencies: \(.totalDependencies)\n- Vulnerabilities: \(.vulnerabilities.total)"' >> dependency-report.md
          fi
          
          echo "## Backend Dependencies" >> dependency-report.md
          if [ -f backend/backend-audit.json ]; then
            echo "### Security Audit" >> dependency-report.md
            cat backend/backend-audit.json | jq -r '.metadata | "- Total dependencies: \(.totalDependencies)\n- Vulnerabilities: \(.vulnerabilities.total)"' >> dependency-report.md
          fi

      - name: ðŸ“Š Upload dependency report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: dependency-report.md

  # ==================== DOCKER IMAGE ANALYSIS ====================
  
  docker-analysis:
    name: ðŸ³ Docker Image Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ§± Build images for analysis
        run: |
          docker build -t test-frontend:latest ./frontend
          docker build -t test-backend:latest ./backend

      - name: ðŸ” Analyze image sizes
        run: |
          echo "ðŸ“Š Docker image sizes:"
          docker images | grep test-
          
          echo "ðŸ” Frontend image layers:"
          docker history test-frontend:latest
          
          echo "ðŸ” Backend image layers:"
          docker history test-backend:latest

      - name: ðŸ”’ Scan images for vulnerabilities
        run: |
          echo "ðŸ” Scanning frontend image..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image test-frontend:latest
          
          echo "ðŸ” Scanning backend image..."
          docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
            aquasec/trivy image test-backend:latest

  # ==================== NOTIFICATION ====================
  
  nightly-summary:
    name: ðŸ“Š Nightly Summary
    runs-on: ubuntu-latest
    needs: [full-test-suite, performance-test, security-audit, dependency-analysis, docker-analysis]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate nightly report
        run: |
          echo "# ðŸŒ™ Nightly Test Report" > nightly-report.md
          echo "Date: $(date)" >> nightly-report.md
          echo "" >> nightly-report.md
          
          echo "## Test Results" >> nightly-report.md
          echo "- Full Test Suite: ${{ needs.full-test-suite.result }}" >> nightly-report.md
          echo "- Performance Test: ${{ needs.performance-test.result }}" >> nightly-report.md
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> nightly-report.md
          echo "- Dependency Analysis: ${{ needs.dependency-analysis.result }}" >> nightly-report.md
          echo "- Docker Analysis: ${{ needs.docker-analysis.result }}" >> nightly-report.md
          
          cat nightly-report.md

      - name: ðŸ“Š Upload nightly report
        uses: actions/upload-artifact@v4
        with:
          name: nightly-report
          path: nightly-report.md
